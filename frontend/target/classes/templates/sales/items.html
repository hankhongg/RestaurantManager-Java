<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restro POS - Restaurant Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }
        .pos-container {
            height: 100vh;
            display: flex;
        }
        .sidebar {
            width: 60px;
            background: #f8fafc;
            border-right: 1px solid #e2e8f0;
        }
        .main-content {
            flex: 1;
            display: flex;
            background: #ffffff;
        }
        .product-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto; /* Added for scrolling if many products */
        }
        .cart-area {
            width: 400px;
            background: #f8fafc;
            /* FIX: Corrected the border-left syntax */
            border-left: 1px solid #e2e8f0;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .product-card {
            background: white;
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
        }
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .product-image {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 8px;
            background-size: cover;
            background-position: center;
        }
        .cart-item {
            padding: 12px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .quantity-btn {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }
        .quantity-btn:hover {
            background: #f3f4f6;
        }
        .active-tab {
            background: #ff6b35 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <div class="pos-container">
        <div class="sidebar flex flex-col items-center py-4 space-y-4">
            <a th:href="@{/sales/tables}" class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center text-gray-600">
                <i class="fas fa-table"></i>
            </a>
            <a th:href="@{/sales/items}" class="w-10 h-10 rounded-lg flex items-center justify-center cursor-pointer bg-orange-500 text-white">
                <i class="fas fa-utensils"></i>
            </a>
            <a th:href="@{/sales/history}" class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center text-gray-600 cursor-pointer hover:bg-gray-300">
                <i class="fas fa-history"></i>
            </a>
            <a th:href="@{/manager/dashboard}" class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center text-gray-600 cursor-pointer hover:bg-gray-300">
                <i class="fas fa-user-shield"></i>
            </a>
            <!-- Logout Button -->
            <button onclick="logout()" class="w-10 h-10 bg-red-500 rounded-lg flex items-center justify-center text-white mt-auto hover:bg-red-600 transition-colors">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>

        <div class="main-content">
            <div class="product-area">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Restro POS</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <input type="text" placeholder="Tìm kiếm sản phẩm..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg w-64 focus:outline-none focus:border-orange-500">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <div class="flex space-x-2 mb-6">
                    <button class="px-4 py-2 rounded-lg active-tab" data-tab-status="all">
                        <i class="fas fa-list mr-2"></i>Tất cả
                    </button>
                    <button class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors" data-tab-status="FOOD">
                        <i class="fas fa-utensils mr-2"></i>Món ăn
                    </button>
                    <button class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors" data-tab-status="DRINK">
                        <i class="fas fa-glass-martini-alt mr-2"></i>Đồ uống
                    </button>
                    <button class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors" data-tab-status="OTHER">
                        <i class="fas fa-box mr-2"></i>Khác
                    </button>
                </div>

                <div class="product-grid" id="productGrid">
                    <div th:each="item : ${items}" class="product-card"
                         th:data-type="${item.itemType}"
                         th:data-name="${item.itemName}"
                         th:data-price="${item.itemSprice}"
                         th:data-item-id="${item.id}"
                         th:data-item-img="${item.itemImg}"
                         onclick="addToCart(this.dataset.name, this.dataset.price, this.dataset.itemId, this.dataset.itemImg)">
                        <div class="product-image" th:style="'background-image: url(' + ${item.itemImg} + ')'"></div>
                        <div class="text-sm font-medium text-gray-800" th:text="${item.itemName}"></div>
                        <div class="text-sm font-bold text-gray-900 mt-1" th:text="${#numbers.formatDecimal(item.itemSprice, 0, 'POINT', 0, 'COMMA')} + '₫'"></div>
                    </div>
                </div>
            </div>

            <div class="cart-area flex flex-col">
                <div class="p-5 border-b border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-4 w-full">
                            <div class="w-1/3">
                                <select id="rightPanelTableSelect" class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <option value="">Chọn bàn</option>
                                    <option th:each="table : ${tables}" th:if="${table.tabStatus} == 'OCCUPIED'" th:value="${table.id}" th:text="'Bàn ' + ${table.id}"></option>
                                </select>
                            </div>
                            <div class="w-2/3">
                                <button onclick="showOnlineOrders()" class="w-full px-6 py-2 bg-orange-500 text-white rounded-lg text-sm hover:bg-orange-600 transition-colors">
                                    <i class="fas fa-shopping-cart mr-2"></i>Kiểm tra đơn online
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto" id="cartItems">
                    </div>

                <div class="p-5 border-t border-gray-200 bg-white">
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-600">Subtotal</span>
                            <span class="font-medium" id="subtotal">0₫</span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-600">Tax (VAT)</span>
                            <span class="font-medium" id="tax">0₫</span>
                        </div>
                        <div class="flex justify-between items-center text-lg font-bold">
                            <span>Total</span>
                            <span id="total">0₫</span>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <button onclick="processOrderToTable()" class="w-full py-3 bg-green-500 text-white rounded-lg font-medium text-lg">
                            <i class="fas fa-check-circle mr-2"></i>Tiến hành phục vụ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Online Orders Modal -->
    <div id="onlineOrdersModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg w-3/4 max-h-[80vh] overflow-hidden relative">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold">Đơn hàng online</h3>
                <button onclick="closeOnlineOrders()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4 overflow-y-auto max-h-[calc(80vh-8rem)]">
                <div id="onlineOrdersList" class="space-y-4">
                    <!-- Orders will be populated here -->
                </div>
            </div>

            <!-- Loading Overlay for Modal -->
            <div id="onlineOrdersLoadingOverlay" class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-10 hidden">
                <i class="fas fa-spinner fa-spin text-orange-500 text-4xl"></i>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script th:inline="none">
        let cart = [];
        let orderCounter = 1; // Used to generate unique IDs for cart items
        let currentTable = ''; // Variable to hold the ID of the currently selected table
        const TAX_RATE = 0.10; // 10% tax
        let onlineOrdersWithNames = []; // Global variable to store online orders with item names

        // Hàm lưu thông tin bàn và món ăn vào localStorage
        function saveTableData(tableId, items) {
            console.log('Saving data for table:', tableId, 'with items:', items);
            const tableData = {
                tableId: tableId,
                items: items,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem(`table_${tableId}`, JSON.stringify(tableData));
        }

        // Hàm lấy thông tin bàn từ localStorage
        function getTableData(tableId) {
            const data = localStorage.getItem(`table_${tableId}`);
            return data ? JSON.parse(data) : null;
        }

        // Helper function to format currency to VND
        function formatCurrency(value) {
            // Using Intl.NumberFormat for robust localization
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
        }

        // Table selection
        function updateTableSelection(tableId) {
            console.log('Updating table selection to:', tableId);
            currentTable = tableId;
            const rightPanelTableSelect = document.getElementById('rightPanelTableSelect');
            if (rightPanelTableSelect) rightPanelTableSelect.value = tableId;
        }

        document.getElementById('rightPanelTableSelect').addEventListener('change', function() {
            const selectedTableId = this.value;
            updateTableSelection(selectedTableId);

            // Clear the cart and update display immediately when a new table is selected
            cart = []; // Always clear cart when selecting a different table
            orderCounter = 1; // Reset counter for the new cart session
            // Do NOT load existing data here. It will be loaded during processOrderToTable.

            updateCartDisplay(); // Update display after loading/clearing cart
        });

        // Display items based on filter
        function displayItems(filter) {
            const productCards = document.querySelectorAll('.product-card');
            productCards.forEach(card => {
                const itemType = card.getAttribute('data-type');
                if (filter === 'all' || itemType === filter) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Tab switching functionality
        document.querySelectorAll('[data-tab-status]').forEach(tab => {
            tab.addEventListener('click', function() {
                const status = this.getAttribute('data-tab-status');
                document.querySelectorAll('[data-tab-status]').forEach(t => {
                    t.classList.remove('active-tab');
                    t.classList.add('bg-gray-200', 'text-gray-700');
                });
                this.classList.add('active-tab');
                this.classList.remove('bg-gray-200', 'text-gray-700');
                displayItems(status);
            });
        });

        // Search functionality
        document.querySelector('input[placeholder*="Tìm kiếm sản phẩm"]').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            const activeFilter = document.querySelector('.active-tab').getAttribute('data-tab-status');
            document.querySelectorAll('.product-card').forEach(card => {
                const itemName = card.getAttribute('data-name').toLowerCase();
                const itemType = card.getAttribute('data-type');
                const matchesSearch = itemName.includes(searchTerm);
                const matchesFilter = activeFilter === 'all' || itemType === activeFilter;

                if (matchesSearch && matchesFilter) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });

        function addToCart(name, priceString, itemId, itemImg) {
            // Clean the price string before parsing to ensure it's a valid number
            // This handles cases where data-price might contain non-numeric characters like '₫' or commas.
            const cleanPriceString = priceString.replace(/[^0-9.]/g, '');
            const price = parseFloat(cleanPriceString);

            if (isNaN(price)) {
                console.error('Invalid price encountered for item:', name, 'raw string:', priceString, 'cleaned:', cleanPriceString);
                alert('Giá sản phẩm không hợp lệ!');
                return; // Stop function if price is not a number
            }

            // Find if the item already exists in the current cart using itemId
            const existingItemIndex = cart.findIndex(item => item.itemId === itemId);
            if (existingItemIndex > -1) {
                cart[existingItemIndex].quantity += 1;
                // Recalculate total price for the existing item
                cart[existingItemIndex].totalPrice = cart[existingItemIndex].price * cart[existingItemIndex].quantity;
            } else {
                // Assign a unique temporary ID for this cart item
                const newItem = {
                    id: orderCounter++, // Unique temporary ID for this cart session
                    itemId: itemId, // Backend item ID
                    name: name,
                    price: price,
                    quantity: 1,
                    discount: 0,
                    image: itemImg, // Save image URL
                    totalPrice: price // Initial total price for one item
                };
                cart.push(newItem);
            }
            updateCartDisplay();
        }

        function removeFromCart(id) {
            // Remove item using the temporary 'id'
            cart = cart.filter(item => item.id !== id);
            updateCartDisplay();
        }

        function updateQuantity(id, change) {
            // Find item using the temporary 'id'
            const item = cart.find(item => item.id === id);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    removeFromCart(id);
                } else {
                    // Recalculate total price for the updated item
                    item.totalPrice = item.price * item.quantity;
                    updateCartDisplay();
                }
            }
        }

        function updateCartDisplay() {
            const cartItemsContainer = document.getElementById('cartItems');
            const subtotalElement = document.getElementById('subtotal');
            const taxElement = document.getElementById('tax');
            const totalElement = document.getElementById('total');

            cartItemsContainer.innerHTML = '';
            let subtotal = 0;

            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-center text-gray-500">Không có món ăn nào được chọn</p>';
            } else {
                 cart.forEach((item, index) => {
                    const itemTotal = item.price * item.quantity;
                    subtotal += itemTotal;

                    // FIX: Corrected item numbering using index + 1
                    const cartItemHtml = `
                        <div class="cart-item">
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="font-medium text-sm">${index + 1}. ${item.name}</span>
                                    <div class="flex items-center">
                                        <span class="font-bold mr-3">${formatCurrency(itemTotal)}</span>
                                        <button onclick="removeFromCart(${item.id})" class="text-gray-400 hover:text-red-500">
                                            <i class="fas fa-times fa-sm"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center mt-1">
                                    <div class="quantity-controls">
                                        <button onclick="updateQuantity(${item.id}, -1)" class="quantity-btn">-</button>
                                        <span class="w-8 text-center text-sm font-medium">${item.quantity}</span>
                                        <button onclick="updateQuantity(${item.id}, 1)" class="quantity-btn">+</button>
                                    </div>
                                    <span class="text-xs text-gray-500">Đơn giá: ${formatCurrency(item.price)}</span>
                                </div>
                            </div>
                        </div>`;
                    cartItemsContainer.innerHTML += cartItemHtml;
                });
            }

            const tax = subtotal * TAX_RATE;
            const total = subtotal + tax;

            subtotalElement.textContent = formatCurrency(subtotal);
            taxElement.textContent = formatCurrency(tax);
            totalElement.textContent = formatCurrency(total);
        }

        async function processOrderToTable() {
            console.log('Processing order for table:', currentTable);
            const selectedTable = currentTable;
            
            if (!selectedTable) {
                alert('Vui lòng chọn bàn trước khi tiến hành!');
                return;
            }
            if (cart.length === 0) {
                alert('Giỏ hàng trống. Vui lòng thêm món ăn!');
                return;
            }

            // 1. Load existing data for the table
            let tableData = getTableData(selectedTable);
            if (!tableData) {
                // If no existing data, start with an empty items array
                tableData = { tableId: selectedTable, items: [], timestamp: new Date().toISOString() };
            } else {
                // Use existing items, but ensure they have a temporary 'id' if missing
                tableData.items.forEach(item => { 
                    if (!item.id) item.id = orderCounter++;
                    // Ensure totalPrice is calculated correctly for existing items
                    item.totalPrice = item.price * item.quantity;
                });
            }

            // 2. Merge current cart items with existing table items
            cart.forEach(cartItem => {
                const existingItemIndex = tableData.items.findIndex(tableItem => tableItem.itemId === cartItem.itemId);
                if (existingItemIndex > -1) {
                    // Item exists, update quantity and total price
                    tableData.items[existingItemIndex].quantity += cartItem.quantity;
                    tableData.items[existingItemIndex].totalPrice = tableData.items[existingItemIndex].price * tableData.items[existingItemIndex].quantity;
                } else {
                    // Item is new for this table, add it with calculated totalPrice
                    const newItem = {
                        ...cartItem,
                        id: cartItem.id || orderCounter++,
                        totalPrice: cartItem.price * cartItem.quantity // Ensure totalPrice is calculated for new items
                    };
                    tableData.items.push(newItem);
                }
            });

            // 3. Save the merged data back to localStorage
            saveTableData(selectedTable, tableData.items);

            // 4. Generate PDF (using the merged items from tableData.items) - This is a kitchen receipt
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Use Arial font for better English support
            doc.setFont('Arial', 'normal');

            const pdfTitle = 'Kitchen Order Ticket';
            doc.setFontSize(22);
            doc.text(pdfTitle, doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });

            let currentY = 35;
            doc.setFontSize(12);
            doc.text(`Table No: ${selectedTable}`, 14, currentY);
            currentY += 7;
            doc.text(`Time: ${new Date().toLocaleString('en-US')}`, 14, currentY);
            currentY += 10;

            // Use the current cart items for PDF generation (only newly added)
            const tableDataPdf = cart.map((item, index) => [
                index + 1,
                item.name,
                item.quantity,
                formatCurrency(item.price).replace('₫', '').trim(),
                formatCurrency(item.price * item.quantity).replace('₫', '').trim()
            ]);

            doc.autoTable({
                startY: currentY,
                head: [['No.', 'Item Name', 'Qty', 'Unit Price', 'Subtotal']],
                body: tableDataPdf,
                theme: 'grid',
                headStyles: { fillColor: [255, 107, 53] },
                styles: { font: 'Arial' }
            });

            const finalY = doc.lastAutoTable.finalY;
            // Calculate totals based on the current cart items
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const taxRate = 0.10;
            const tax = subtotal * taxRate;
            const total = subtotal + tax;

            doc.setFontSize(12);
            doc.text('Subtotal:', 150, finalY + 10, { align: 'right' });
            doc.text(formatCurrency(subtotal).replace('₫', '').trim(), 200, finalY + 10, { align: 'right' });

            doc.text(`Tax (VAT ${taxRate * 100}%):`, 150, finalY + 17, { align: 'right' });
            doc.text(formatCurrency(tax).replace('₫', '').trim(), 200, finalY + 17, { align: 'right' });

            doc.setFontSize(14);
            doc.setFont('Arial', 'bold');
            doc.text('Total:', 150, finalY + 26, { align: 'right' });
            doc.text(formatCurrency(total).replace('₫', '').trim(), 200, finalY + 26, { align: 'right' });

            doc.save(`kitchen-ticket-table-${selectedTable}-${new Date().getTime()}.pdf`); // Add timestamp to filename

            // 5. Clear the current cart and update display after processing
            cart = [];
            updateCartDisplay();

            alert('Đơn hàng đã được xử lý và lưu vào bàn ' + selectedTable + '. Vui lòng xem hóa đơn bếp.');
        }

        // Online Orders Modal Functions - Restored
        function showOnlineOrders() {
            const modal = document.getElementById('onlineOrdersModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            fetchOnlineOrders();
        }

        function closeOnlineOrders() {
            const modal = document.getElementById('onlineOrdersModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function fetchOnlineOrders() {
            const loadingOverlay = document.getElementById('onlineOrdersLoadingOverlay');
            loadingOverlay.classList.remove('hidden'); // Show spinner

            try {
                const response = await fetch('/sales/api/online-orders?status=PENDING');
                const orders = await response.json();
                await displayOnlineOrders(orders); // Wait for item names to be fetched and displayed
            } catch (error) {
                console.error('Error fetching online orders:', error);
                alert('Không thể tải đơn hàng online. Vui lòng thử lại sau.');
            } finally {
                loadingOverlay.classList.add('hidden'); // Hide spinner
            }
        }

        async function displayOnlineOrders(orders) {
            const ordersList = document.getElementById('onlineOrdersList');
            ordersList.innerHTML = '';

            if (orders.length === 0) {
                ordersList.innerHTML = '<p class="text-center text-gray-500">Không có đơn hàng online nào</p>';
                onlineOrdersWithNames = [];
                return;
            }

            const processedOrders = [];

            for (const order of orders) {
                const orderDetailsWithNames = await Promise.all(
                    order.orderDetails.map(async (detail) => {
                        try {
                            const response = await fetch(`http://localhost:8080/items/${detail.itemId}`);
                            const item = await response.json();
                            return {
                                ...detail,
                                itemName: item.itemName
                            };
                        } catch (error) {
                            console.error('Error fetching item name:', error);
                            return {
                                ...detail,
                                itemName: `Item ${detail.itemId}`
                            };
                        }
                    })
                );

                const processedOrder = { ...order, orderDetails: orderDetailsWithNames };
                processedOrders.push(processedOrder);

                const orderElement = document.createElement('div');
                orderElement.className = 'border border-gray-200 rounded-lg p-4';
                orderElement.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="font-semibold">${processedOrder.customerName}</h4>
                            <p class="text-sm text-gray-600">${processedOrder.phoneNumber}</p>
                            <p class="text-sm text-gray-600">${processedOrder.address}</p>
                            ${processedOrder.note ? `<p class="text-sm text-gray-600">Ghi chú: ${processedOrder.note}</p>` : ''}
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">Thời gian đặt: ${new Date(processedOrder.orderTime).toLocaleString('vi-VN')}</p>
                            <p class="font-semibold text-orange-500">${formatCurrency(processedOrder.totalAmount)}</p>
                        </div>
                    </div>
                    <div class="space-y-2">
                        ${processedOrder.orderDetails.map(detail => `
                            <div class="flex justify-between items-center text-sm">
                                <span>${detail.itemName} x ${detail.quantity}</span>
                                <span>${formatCurrency(detail.price * detail.quantity)}</span>
                            </div>
                            ${detail.note ? `<div class="text-sm text-gray-500">Ghi chú: ${detail.note}</div>` : ''}
                        `).join('')}
                    </div>
                    <div class="mt-4 flex justify-end space-x-2">
                        <button onclick="acceptOrder(${processedOrder.id})" class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600">
                            <i class="fas fa-check mr-1"></i>Nhận đơn
                        </button>
                        <button onclick="rejectOrder(${processedOrder.id})" class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600">
                            <i class="fas fa-times mr-1"></i>Từ chối
                        </button>
                    </div>
                `;
                ordersList.appendChild(orderElement);
            }

            onlineOrdersWithNames = processedOrders;
        }

        async function acceptOrder(orderId) {
            const loadingOverlay = document.getElementById('onlineOrdersLoadingOverlay');
            loadingOverlay.classList.remove('hidden'); // Show spinner
            try {
                const order = onlineOrdersWithNames.find(order => order.id === orderId);
                if (!order) {
                    console.error('Error: Order not found in displayed list.');
                    throw new Error('Order not found in displayed list.');
                }

                // Lấy accEmail từ localStorage
                let accEmail = null;
                let loggedInUser = null;
                try {
                    const loggedInUserStr = localStorage.getItem('loggedInUser');
                    console.log('localStorage loggedInUser string:', loggedInUserStr);
                    if (loggedInUserStr) {
                        loggedInUser = JSON.parse(loggedInUserStr);
                        if (loggedInUser && loggedInUser.accEmail) {
                            accEmail = loggedInUser.accEmail;
                            console.log('Extracted accEmail from localStorage:', accEmail);
                        }
                    }
                } catch (e) {
                    console.error('Error parsing loggedInUser from localStorage:', e);
                    accEmail = null;
                }
                
                if (!accEmail) {
                    alert('Không xác định được email nhân viên từ tài khoản đăng nhập. Vui lòng đăng nhập lại và đảm bảo tài khoản có email hợp lệ!');
                    loadingOverlay.classList.add('hidden');
                    loadingOverlay.classList.remove('flex');
                    return;
                }

                // Fetch all employees và tìm theo email
                let employeeId = null;
                try {
                    console.log('Fetching employees from /manager/api/employees');
                    const res = await fetch('http://localhost:8080/employees');
                    if (!res.ok) {
                        throw new Error(`Failed to fetch employees: ${res.statusText}`);
                    }
                    const employees = await res.json();
                    console.log('Fetched employees:', employees);

                    const found = employees.find(emp => emp.email === accEmail);
                    if (found) {
                        employeeId = found.id;
                        console.log('Found employee ID:', employeeId, 'for email:', accEmail);
                    } else {
                        console.warn('No employee found with email:', accEmail, 'in the fetched list.');
                    }
                } catch (e) {
                    console.error('Error fetching or finding employee:', e);
                    employeeId = null;
                }

                if (!employeeId) {
                    alert('Không tìm thấy ID nhân viên phù hợp với email đăng nhập. Vui lòng kiểm tra dữ liệu nhân viên!');
                    loadingOverlay.classList.add('hidden');
                    loadingOverlay.classList.remove('flex');
                    return;
                }

                console.log('Attempting to send employeeId to backend:', employeeId);
                const prepareResponse = await fetch(`/sales/api/online-orders/${orderId}/status?status=PREPARING&employeeId=${employeeId}`, {
                    method: 'PUT'
                });
                if (!prepareResponse.ok) {
                     const errorText = await prepareResponse.text();
                     console.error(`Failed to update order status: ${prepareResponse.status} - ${errorText}`);
                     throw new Error(`Failed to update order status: ${prepareResponse.statusText}`);
                }
               
                console.log('Order status updated to PREPARING for order:', orderId);

                // Generate PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFont('Arial', 'normal');

                const pdfTitle = 'Payment Invoice';
                doc.setFontSize(22);
                doc.text(pdfTitle, doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });

                let currentY = 35;
                doc.setFontSize(12);
                doc.text(`Customer Name: ${order.customerName}`, 14, currentY);
                currentY += 7;
                doc.text(`Phone Number: ${order.phoneNumber}`, 14, currentY);
                currentY += 7;
                doc.text(`Address: ${order.address}`, 14, currentY);
                currentY += 7;

                if (order.note) {
                    doc.text(`Order Note: ${order.note}`, 14, currentY);
                    currentY += 7;
                }
                doc.text(`Order Time: ${new Date(order.orderTime).toLocaleString('en-US')}`, 14, currentY);
                currentY += 7;

                const tableData = order.orderDetails.map((detail, index) => [
                    index + 1,
                    detail.itemName || `Item ${detail.itemId}`,
                    detail.quantity,
                    formatCurrency(detail.price).replace('₫', '').trim(),
                    formatCurrency(detail.price * detail.quantity).replace('₫', '').trim()
                ]);

                doc.autoTable({
                    startY: currentY,
                    head: [['No.', 'Item Name', 'Qty', 'Unit Price', 'Subtotal']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: { fillColor: [255, 107, 53] },
                    styles: { font: 'Arial' }
                });

                const finalY = doc.lastAutoTable.finalY;
                const subtotal = order.orderDetails.reduce((sum, detail) => sum + (detail.price * detail.quantity), 0);
                const taxRate = 0.10;
                const tax = subtotal * taxRate;
                const total = subtotal + tax;

                doc.setFontSize(12);
                doc.text('Subtotal:', 150, finalY + 10, { align: 'right' });
                doc.text(formatCurrency(subtotal).replace('₫', '').trim(), 200, finalY + 10, { align: 'right' });

                doc.text(`Tax (VAT ${taxRate * 100}%):`, 150, finalY + 17, { align: 'right' });
                doc.text(formatCurrency(tax).replace('₫', '').trim(), 200, finalY + 17, { align: 'right' });

                doc.setFontSize(14);
                doc.setFont('Arial', 'bold');
                doc.text('Total:', 150, finalY + 26, { align: 'right' });
                doc.text(formatCurrency(total).replace('₫', '').trim(), 200, finalY + 26, { align: 'right' });

                doc.save(`invoice-${order.customerName.replace(/ /g, '_')}.pdf`);

            } catch (error) {
                console.error('Error accepting order:', error);
                alert('Không thể nhận đơn hàng. Vui lòng thử lại sau.');
            } finally {
                loadingOverlay.classList.add('hidden'); // Hide spinner
                fetchOnlineOrders(); // Refresh the list
            }
        }

        // Restore rejectOrder function
        async function rejectOrder(orderId) {
            const loadingOverlay = document.getElementById('onlineOrdersLoadingOverlay');
            loadingOverlay.classList.remove('hidden'); // Show spinner

            try {
                const response = await fetch(`/sales/api/online-orders/${orderId}/status?status=CANCELLED`, {
                    method: 'PUT'
                });
                const order = await response.json();
                console.log('Order rejected:', order);
            } catch (error) {
                console.error('Error rejecting order:', error);
                alert('Không thể từ chối đơn hàng. Vui lòng thử lại sau.');
            } finally {
                loadingOverlay.classList.add('hidden'); // Hide spinner
                fetchOnlineOrders(); // Refresh the list
            }
        }

        // Close modal when clicking outside
        document.getElementById('onlineOrdersModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeOnlineOrders();
            }
        });

        // Call updateCartDisplay initially to show empty cart
        updateCartDisplay();

        // Initialize currentTable from URL parameter on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded fired.');
            const urlParams = new URLSearchParams(window.location.search);
            const tableIdFromUrl = urlParams.get('tableId');
            if (tableIdFromUrl) {
                // Ensure the dropdown reflects the selected table from URL
                updateTableSelection(tableIdFromUrl);
                // Do NOT load existing items into the cart on page load
                cart = []; // Ensure cart is empty initially
                updateCartDisplay(); // Update display to show empty cart
            } else {
                // If no tableId in URL, ensure 'Chọn bàn' is selected and cart is empty
                currentTable = ''; // Ensure currentTable variable is empty
                const rightPanelTableSelect = document.getElementById('rightPanelTableSelect');
                if (rightPanelTableSelect) {
                     rightPanelTableSelect.selectedIndex = 0; // Select the first option ('Chọn bàn')
                }
                cart = []; // Ensure cart is empty
                updateCartDisplay();
             }
            // Initial display of items (all)
            displayItems('all');

             // Re-populate table dropdown with sorted tables after they are available
             // Assuming tables are available globally or fetched here if not.
             // If tables are fetched via an API call directly in this JS, the sorting should happen there.
             // Since they are passed via Thymeleaf, the sorting in Controller was attempted.
             // Let's add sorting to the dropdown population logic if we can access the tables array here.

             // *Correction*: The tables array is available via Thymeleaf in the HTML.
             // We need to sort the options after the page loads.
             console.log('Calling sortTableDropdown');
             sortTableDropdown();

            // After sorting and potential URL selection, ensure 'Chọn bàn' is selected if no URL tableId
            if (!tableIdFromUrl) {
                const rightPanelTableSelect = document.getElementById('rightPanelTableSelect');
                 if (rightPanelTableSelect) {
                     rightPanelTableSelect.selectedIndex = 0; // Re-select the first option ('Chọn bàn')
                 }
                 currentTable = ''; // Ensure currentTable is empty
            }
            // Also ensure the cart is empty and display updated if no tableIdFromUrl
            if (!tableIdFromUrl && cart.length > 0) {
                cart = [];
                updateCartDisplay();
            }
        });

        // Function to sort the table dropdown by ID
        function sortTableDropdown() {
            console.log('sortTableDropdown function started.');
            const selectElement = document.getElementById('rightPanelTableSelect');
            if (!selectElement) {
                console.error('rightPanelTableSelect not found!');
                return;
            }
            console.log('Found select element:', selectElement);

            const options = Array.from(selectElement.options);
            console.log('Original options:', options.map(opt => ({ value: opt.value, text: opt.text })));

            // Sort options based on the numerical value of the 'value' attribute (which is table ID)
            options.sort((a, b) => {
                const idA = parseInt(a.value);
                const idB = parseInt(b.value);
                console.log(`Comparing ${a.text} (ID: ${idA}) and ${b.text} (ID: ${idB})`);
                // Handle 'Chọn bàn' option or invalid IDs if necessary
                if (isNaN(idA)) return -1; // Keep 'Chọn bàn' at the top
                if (isNaN(idB)) return 1; // Keep 'Chọn bàn' at the top
                return idA - idB;
            });

            // Clear existing options and add sorted options back
            console.log('Clearing existing options.');
            while (selectElement.options.length > 0) {
                selectElement.remove(0);
            }
            console.log('Adding sorted options back.');
            options.forEach(option => selectElement.add(option));
            console.log('Sorted options added.');

             // Re-select the current table if one was selected via URL
             const urlParams = new URLSearchParams(window.location.search);
             const tableIdFromUrl = urlParams.get('tableId');
             console.log('Checking for tableId from URL:', tableIdFromUrl);
             if (tableIdFromUrl) {
                 selectElement.value = tableIdFromUrl;
                 updateTableSelection(tableIdFromUrl); // Ensure currentTable variable is updated
                 console.log('Selected table from URL:', tableIdFromUrl);
             }
            console.log('sortTableDropdown function finished.');
        }

        // The tab switching logic already handles showing/hiding based on status when a tab is clicked.
        // No need to re-apply display logic in action functions, instead trigger tab click.

        // Add a checkout function placeholder
        function checkout(tableId) {
             alert('Chức năng thanh toán cho bàn ' + tableId + ' sẽ được triển khai sau.');
             // TODO: Implement checkout process
        }

        // Global spinner functions (if not already defined elsewhere)
        function showGlobalSpinner() {
            document.getElementById('spinnerOverlay').classList.remove('hidden');
            document.getElementById('spinnerOverlay').classList.add('flex');
        }

        function hideGlobalSpinner() {
            document.getElementById('spinnerOverlay').classList.add('hidden');
            document.getElementById('spinnerOverlay').classList.remove('flex');
        }

        // Logout function
        function logout() {
            showGlobalSpinner();
            // Clear any user session data from localStorage
            localStorage.removeItem('loggedInUser');
            localStorage.removeItem('lastSelectedTableId');
            // Redirect to login page after a small delay to show spinner
            setTimeout(() => {
                window.location.href = '/login';
            }, 500); // 500ms delay
        }
    </script>

    <!-- Spinner Overlay -->
    <div id="spinnerOverlay" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-[100] hidden">
        <div class="w-16 h-16 border-4 border-orange-500 border-t-transparent rounded-full animate-spin"></div>
    </div>
</body>
</html>
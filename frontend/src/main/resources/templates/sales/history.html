<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restro POS - Lịch sử bán hàng (Tailwind Only)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    </head>
<body class="font-sans bg-white overflow-hidden">
    <div class="h-screen flex">
        <div class="w-[60px] bg-slate-50 border-r border-slate-200 flex flex-col items-center py-4 space-y-4">
            <a th:href="@{/sales/tables}" class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center text-gray-600 cursor-pointer hover:bg-gray-300">
                <i class="fas fa-table"></i>
            </a>
            <a th:href="@{/sales/items}" class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center text-gray-600 cursor-pointer hover:bg-gray-300">
                <i class="fas fa-utensils"></i>
            </a>
            <a th:href="@{/sales/history}" class="w-10 h-10 rounded-lg flex items-center justify-center cursor-pointer bg-orange-500 text-white">
                <i class="fas fa-history"></i>
            </a>
        </div>

        <div class="flex-1 flex flex-col bg-white overflow-y-auto">
            <div class="flex-1 p-5">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Lịch sử Giao dịch</h1>
                        <p class="text-sm text-gray-500 mt-1">Xem lại các đơn hàng đã hoàn thành</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button class="px-4 py-2 bg-orange-500 text-white rounded-lg text-sm font-medium hover:bg-orange-600">
                            <i class="fas fa-file-export mr-2"></i>Xuất báo cáo
                        </button>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg mb-6">
                    <div class="flex flex-wrap items-center gap-4">
                        <h3 class="text-sm font-semibold text-gray-700 mr-2">Lọc theo:</h3>
                        <div class="flex items-center space-x-2" id="filter-buttons">
                            <button class="py-2 px-4 rounded-lg font-medium text-sm transition-colors duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300">Tất cả</button>
                            <button class="py-2 px-4 rounded-lg font-medium text-sm transition-colors duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300">Hôm nay</button>
                            <button class="py-2 px-4 rounded-lg bg-gray-200 text-gray-700 font-medium text-sm transition-colors duration-200 hover:bg-gray-300">Hôm qua</button>
                            <button class="py-2 px-4 rounded-lg bg-gray-200 text-gray-700 font-medium text-sm transition-colors duration-200 hover:bg-gray-300">7 ngày qua</button>
                            <button class="py-2 px-4 rounded-lg bg-gray-200 text-gray-700 font-medium text-sm transition-colors duration-200 hover:bg-gray-300">Tháng này</button>
                        </div>
                        <div class="flex items-center space-x-2">
                             <input type="date" class="pl-4 pr-2 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-orange-500">
                             <span class="text-gray-500">-</span>
                             <input type="date" class="pl-4 pr-2 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-orange-500">
                        </div>
                        <div class="relative flex-1 min-w-[200px]">
                            <input type="text" placeholder="Tìm theo mã đơn, khách hàng..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg w-full focus:outline-none focus:border-orange-500 text-sm">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3" style="width: fit-content;">Mã Đơn Hàng</th>
                                <th scope="col" class="px-6 py-3">Thời gian</th>
                                <th scope="col" class="px-6 py-3">Nhân viên</th>
                                <th scope="col" class="px-6 py-3">Khách hàng</th>
                                <th scope="col" class="px-6 py-3">Địa chỉ</th>
                                <th scope="col" class="px-6 py-3">Phương thức</th>
                                <th scope="col" class="px-6 py-3">Trạng thái</th>
                                <th scope="col" class="px-6 py-3 text-right">Tổng tiền</th>
                                <th scope="col" class="px-6 py-3 text-center">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="ordersHistoryTableBody">
                            <!-- Orders history rows will be populated here by JavaScript -->
                        </tbody>
                    </table>

                     <div class="flex justify-between items-center p-4">
                        <span class="text-sm text-gray-700">
                            Hiển thị <span class="font-semibold text-gray-900">1</span>-<span class="font-semibold text-gray-900">10</span> của <span class="font-semibold text-gray-900">100</span>
                        </span>
                        <div class="inline-flex items-center -space-x-px">
                            <a href="#" class="px-3 py-2 ml-0 leading-tight text-gray-500 bg-white border border-gray-300 rounded-l-lg hover:bg-gray-100 hover:text-gray-700">
                                <i class="fas fa-chevron-left text-xs"></i>
                            </a>
                            <a href="#" class="px-3 py-2 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700">1</a>
                             <a href="#" aria-current="page" class="z-10 px-3 py-2 leading-tight text-orange-600 border border-orange-300 bg-orange-50 hover:bg-orange-100 hover:text-orange-700">2</a>
                            <a href="#" class="px-3 py-2 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700">3</a>
                            <a href="#" class="px-3 py-2 leading-tight text-gray-500 bg-white border border-gray-300 rounded-r-lg hover:bg-gray-100 hover:text-gray-700">
                                <i class="fas fa-chevron-right text-xs"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allOrders = []; // Store all fetched orders
        let filteredOrders = []; // Store orders after filtering and searching
        let currentPage = 1;
        const itemsPerPage = 6; // Number of orders per page
        let currentFilter = 'Tất cả'; // Default filter
        let searchTerm = '';

        // Định nghĩa các class cho từng trạng thái của nút filter
        const activeClasses = ['bg-orange-500', 'text-white'];
        const inactiveClasses = ['bg-gray-200', 'text-gray-700', 'hover:bg-orange-600', 'hover:text-white'];

        // Helper function to get status color class
        function getStatusColorClass(status) {
            switch (status) {
                case 'COMPLETED': return 'bg-green-100 text-green-800';
                case 'CANCELLED': return 'bg-red-100 text-red-800';
                case 'PREPARING': return 'bg-blue-100 text-blue-800';
                case 'DELIVERING': return 'bg-yellow-100 text-yellow-800';
                case 'Hoàn thành': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Helper function to format currency to VND
        function formatCurrency(value) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
        }

        document.addEventListener('DOMContentLoaded', function() {
            fetchOrdersHistory();

            // Close modal when clicking outside
            document.getElementById('orderDetailsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeOrderDetailsModal();
                }
            });

            // Add event listeners for filter buttons
            document.querySelectorAll('#filter-buttons button').forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    document.querySelectorAll('#filter-buttons button').forEach(btn => {
                         btn.classList.remove(...activeClasses);
                         btn.classList.add(...inactiveClasses);
                    });

                    // Add active class to clicked button
                    this.classList.remove(...inactiveClasses);
                    this.classList.add(...activeClasses);

                    currentFilter = this.textContent.trim();
                    // Reset date inputs when filter button is clicked, unless it's a custom range button (not implemented yet)
                    if (currentFilter !== 'custom') {
                       document.querySelectorAll('input[type="date"]').forEach(input => input.value = '');
                    }
                    applyFiltersAndSearch();
                });
            });

            // Add event listeners for date inputs
            document.querySelectorAll('input[type="date"]').forEach(input => {
                 input.addEventListener('change', function() {
                     // Deactivate filter buttons when date input is used
                      document.querySelectorAll('#filter-buttons button').forEach(btn => {
                         btn.classList.remove(...activeClasses);
                         btn.classList.add(...inactiveClasses);
                     });
                     currentFilter = 'custom'; // Indicate custom date range filter
                     applyFiltersAndSearch();
                 });
            });

            // Add event listener for search input
            const searchInput = document.querySelector('input[placeholder*="Tìm theo mã đơn, khách hàng..."]');
            if(searchInput) {
                searchInput.addEventListener('input', function() {
                    searchTerm = this.value.toLowerCase();
                    applyFiltersAndSearch();
                });
            }

            // Set default filter button active (Tất cả)
            const allButton = document.querySelector('#filter-buttons button:nth-child(1)');
            if(allButton) {
                allButton.classList.remove(...inactiveClasses);
                allButton.classList.add(...activeClasses);
            }
        });

        async function fetchOrdersHistory() {
            try {
                const [onlineOrdersResponse, receiptsResponse] = await Promise.all([
                    fetch('http://localhost:8080/orders'),
                    fetch('http://localhost:8080/receipts')
                ]);

                if (!onlineOrdersResponse.ok || !receiptsResponse.ok) {
                    throw new Error('Failed to fetch orders history');
                }

                const onlineOrders = await onlineOrdersResponse.json();
                const receipts = await receiptsResponse.json();

                allOrders = [
                    ...onlineOrders.map(order => ({
                        ...order,
                        type: 'online',
                        time: new Date(order.orderTime)
                    })),
                    ...receipts.map(receipt => ({
                        ...receipt,
                        type: 'receipt',
                        time: new Date(receipt.recTime),
                        customerName: receipt.customerName,
                        employeeName: receipt.employeeName
                    }))
                ].sort((a, b) => b.time - a.time);

                applyFiltersAndSearch();

            } catch (error) {
                console.error('Error fetching orders history:', error);
                alert('Không thể tải lịch sử đơn hàng. Vui lòng thử lại sau.');
                const tableBody = document.getElementById('ordersHistoryTableBody');
                tableBody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">Lỗi tải dữ liệu.</td></tr>';
            }
        }

        function applyFiltersAndSearch() {
            let ordersToFilter = [...allOrders];

            // Apply Date Filter
            const startDateInput = document.querySelectorAll('input[type="date"]')[0];
            const endDateInput = document.querySelectorAll('input[type="date"]')[1];
            const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
            let endDate = endDateInput.value ? new Date(endDateInput.value) : null;

             if (endDate) {
                 // Set end date to the end of the day
                 endDate.setHours(23, 59, 59, 999);
             }

            // Apply Date Filter based on currentFilter
            if (currentFilter === 'Tất cả') {
                // No date filtering needed for 'Tất cả'
            } else if (currentFilter === 'Hôm nay') {
                 const today = new Date();
                 today.setHours(0, 0, 0, 0);
                 const tomorrow = new Date(today);
                 tomorrow.setDate(tomorrow.getDate() + 1);
                 ordersToFilter = ordersToFilter.filter(order => order.time >= today && order.time < tomorrow);
            } else if (currentFilter === 'Hôm qua') {
                 const yesterday = new Date();
                 yesterday.setDate(yesterday.getDate() - 1);
                 yesterday.setHours(0, 0, 0, 0);
                 const today = new Date(yesterday);
                 today.setDate(today.getDate() + 1);
                 ordersToFilter = ordersToFilter.filter(order => order.time >= yesterday && order.time < today);
            } else if (currentFilter === '7 ngày qua') {
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                sevenDaysAgo.setHours(0, 0, 0, 0);
                ordersToFilter = ordersToFilter.filter(order => order.time >= sevenDaysAgo);
            } else if (currentFilter === 'Tháng này') {
                 const now = new Date();
                 const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                 const startOfNextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                 ordersToFilter = ordersToFilter.filter(order => order.time >= startOfMonth && order.time < startOfNextMonth);
            } else if (currentFilter === 'custom') {
                 if (startDate && endDate) {
                    ordersToFilter = ordersToFilter.filter(order => order.time >= startDate && order.time <= endDate);
                 } else if (startDate) {
                     ordersToFilter = ordersToFilter.filter(order => order.time >= startDate);
                 } else if (endDate) {
                     ordersToFilter = ordersToFilter.filter(order => order.time <= endDate);
                 } else {
                    // If no dates are selected for custom filter, show all
                    // No filtering needed here
                 }
            }

            // Apply Search Term
            if (searchTerm) {
                ordersToFilter = ordersToFilter.filter(order => {
                    const orderId = order.type === 'online' ? `#ORD-${order.id}` : `#REC-${order.id}`;
                    const customerInfo = order.type === 'online' ? (order.customerName || 'Khách vãng lai') : 'Khách vãng lai';
                    const address = order.type === 'online' ? order.address : `Bàn số ${order.tabId}`;

                    return orderId.toLowerCase().includes(searchTerm) ||
                           customerInfo.toLowerCase().includes(searchTerm) ||
                           address.toLowerCase().includes(searchTerm);
                });
            }

            filteredOrders = ordersToFilter;
            currentPage = 1; // Reset to first page after filtering/searching
            renderTable(); // Render the table with filtered/searched data
        }

        function renderTable() {
            const tableBody = document.getElementById('ordersHistoryTableBody');
            tableBody.innerHTML = '';

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedOrders = filteredOrders.slice(startIndex, endIndex);

            if (paginatedOrders.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">Không có lịch sử đơn hàng.</td></tr>';
            } else {
                paginatedOrders.forEach(order => {
                const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-gray-50'; // Removed cursor-pointer as we'll handle clicks specifically

                    // ... (your existing variables like orderId, orderTime are still needed here)
                    const orderId = order.type === 'online' ? `#ORD-${order.id}` : `#REC-${order.id}`;
                    const orderTime = new Date(order.type === 'online' ? order.orderTime : order.recTime).toLocaleString('vi-VN');
                    const customerInfo = order.customerName || 'Khách vãng lai';
                    const address = order.type === 'online' ? (order.address || 'N/A') : `Bàn số ${order.tabId}`;
                    const paymentMethod = order.type === 'online' ? order.paymentMethod : order.paymentMethod; // Assume same field name for simplicity
                    
                    let statusCellContent;
                    let currentStatusText;

                    if (order.type === 'online') {
                         currentStatusText = order.status || 'PENDING'; // Default to PENDING if status is null
                     } else { // Receipt
                        currentStatusText = 'Hoàn thành';
                     }

                     const statusColorClass = getStatusColorClass(currentStatusText);
                     statusCellContent = `
                         <span class="px-2 py-1 text-xs font-medium ${statusColorClass} rounded-full">${currentStatusText}</span>
                     `;


                row.innerHTML = `
                        <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap" style="width: fit-content;">${orderId}</th>
                        <td class="px-6 py-4">${orderTime}</td>
                        <td class="px-6 py-4">${order.employeeName || 'N/A'}</td>
                        <td class="px-6 py-4">${customerInfo}</td>
                        <td class="px-6 py-4">${address}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">${paymentMethod}</span>
                        </td>
                    <td class="px-6 py-4">
                           ${statusCellContent}
                    </td>
                        <td class="px-6 py-4 text-right font-semibold text-gray-900">${formatCurrency(order.type === 'online' ? order.totalAmount : order.recPay)}</td>
                    <td class="px-6 py-4 text-center">
                            <button class="view-details-button font-medium text-orange-600 hover:underline font-bold text-sm" data-order-id="${order.id}" data-order-type="${order.type}">Chi tiết</button>
                    </td>
                `;

                    const detailsButton = row.querySelector('.view-details-button');

                    if (detailsButton) {
                        detailsButton.addEventListener('click', function(event) {
                            event.preventDefault();
                            event.stopPropagation();
                            // Find the order by ID in the original allOrders array
                            const orderId = event.target.getAttribute('data-order-id');
                            const orderType = event.target.getAttribute('data-order-type');
                             const order = allOrders.find(o => o.id == orderId && o.type === orderType); // Match by both ID and type
                            if (order) {
                                showOrderDetailsModal(order);
                            }
                        });
                    }

                    // Removed status select event listener from here

                tableBody.appendChild(row);
            });
        }

            updatePaginationInfo();
        }

        function updatePaginationInfo() {
            const totalItems = filteredOrders.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);

            const paginationInfoSpan = document.querySelector('.flex.justify-between.items-center.p-4 > span');
            if (paginationInfoSpan) {
                if (totalItems === 0) {
                    paginationInfoSpan.innerHTML = 'Hiển thị <span class="font-semibold text-gray-900">0</span>-<span class="font-semibold text-gray-900">0</span> của <span class="font-semibold text-gray-900">0</span>';
                } else {
                     paginationInfoSpan.innerHTML = `Hiển thị <span class="font-semibold text-gray-900">${startItem}</span>-<span class="font-semibold text-gray-900">${endItem}</span> của <span class="font-semibold text-gray-900">${totalItems}</span>`;
                }
            }

            const paginationLinksContainer = document.querySelector('.inline-flex.items-center.-space-x-px');
            if (paginationLinksContainer) {
                paginationLinksContainer.innerHTML = ''; // Clear existing links

                // Previous button
                const prevLink = document.createElement('a');
                prevLink.href = '#';
                prevLink.className = `px-3 py-2 ml-0 leading-tight text-gray-500 bg-white border border-gray-300 rounded-l-lg ${currentPage === 1 ? 'cursor-not-allowed opacity-50' : 'hover:bg-gray-100 hover:text-gray-700'}`;
                prevLink.innerHTML = '<i class="fas fa-chevron-left text-xs"></i>';
                prevLink.onclick = (e) => { e.preventDefault(); if (currentPage > 1) { currentPage--; renderTable(); } };
                paginationLinksContainer.appendChild(prevLink);

                // Page numbers (basic implementation - can be enhanced)
                const maxPageLinks = 5; // Max number of page links to show
                let startPage = Math.max(1, currentPage - Math.floor(maxPageLinks / 2));
                let endPage = Math.min(totalPages, startPage + maxPageLinks - 1);

                 if (endPage - startPage + 1 < maxPageLinks) {
                     startPage = Math.max(1, endPage - maxPageLinks + 1);
                 }

                for (let i = startPage; i <= endPage; i++) {
                    const pageLink = document.createElement('a');
                    pageLink.href = '#';
                    pageLink.className = `px-3 py-2 leading-tight text-gray-500 bg-white border border-gray-300 ${currentPage === i ? 'z-10 text-orange-600 border border-orange-300 bg-orange-50 hover:bg-orange-100 hover:text-orange-700' : 'hover:bg-gray-100 hover:text-gray-700'}`;
                    pageLink.textContent = i;
                    pageLink.onclick = (e) => { e.preventDefault(); currentPage = i; renderTable(); };
                    paginationLinksContainer.appendChild(pageLink);
                }

                // Next button
                const nextLink = document.createElement('a');
                nextLink.href = '#';
                nextLink.className = `px-3 py-2 leading-tight text-gray-500 bg-white border border-gray-300 rounded-r-lg ${currentPage === totalPages || totalItems === 0 ? 'cursor-not-allowed opacity-50' : 'hover:bg-gray-100 hover:text-gray-700'}`;
                nextLink.innerHTML = '<i class="fas fa-chevron-right text-xs"></i>';
                nextLink.onclick = (e) => { e.preventDefault(); if (currentPage < totalPages) { currentPage++; renderTable(); } };
                paginationLinksContainer.appendChild(nextLink);
            }
        }

        function showOrderDetailsModal(order) {
            const modal = document.getElementById('orderDetailsModal');
            document.getElementById('modalOrderId').textContent = order.type === 'online' ? `#ORD-${order.id}` : `#REC-${order.id}`;
            document.getElementById('modalOrderTime').textContent = new Date(order.type === 'online' ? order.orderTime : order.recTime).toLocaleString('vi-VN');
            document.getElementById('modalCustomer').textContent = order.type === 'online' ? (order.customerName || 'Khách vãng lai') : 'Khách vãng lai';
            document.getElementById('modalAddress').textContent = order.type === 'online' ? (order.address || 'N/A') : `Bàn số ${order.tabId}`;
            document.getElementById('modalPaymentMethod').textContent = order.paymentMethod;
            document.getElementById('modalTotalAmount').textContent = formatCurrency(order.type === 'online' ? order.totalAmount : order.recPay);

            // Status badge
            const statusBadge = document.getElementById('modalStatusBadge');
            let statusText;
             if (order.type === 'online') {
                 statusText = order.status;
             } else {
                 statusText = 'Hoàn thành';
             }
            statusBadge.textContent = statusText;
            statusBadge.className = `px-2 py-1 text-xs font-medium rounded-full ${getStatusColorClass(statusText)}`;

            // Order Note (only for online orders)
            const orderNoteRow = document.getElementById('modalOrderNoteRow');
            const orderNoteSpan = document.getElementById('modalOrderNote');
            if (order.type === 'online' && order.note) {
                orderNoteRow.classList.remove('hidden');
                orderNoteSpan.textContent = `Ghi chú đơn hàng: ${order.note}`;
            } else {
                orderNoteRow.classList.add('hidden');
                orderNoteSpan.textContent = '';
            }

            // Item Details
            const itemsList = document.getElementById('modalItemsList');
            itemsList.innerHTML = '';

            const details = order.type === 'online' ? order.orderDetails : order.details;

            if (details && details.length > 0) {
                 const fetchItemDetails = details.map(detail => {
                      if (order.type === 'online') {
                           return fetch(`http://localhost:8080/items/${detail.itemId}`)
                              .then(response => response.json())
                              .then(item => ({
                                ...detail,
                                  itemName: item.itemName || `Item ${detail.itemId}`,
                                  itemSprice: item.itemSprice // Fetch selling price for total calculation if needed
                              }))
                              .catch(error => {
                                   console.error('Error fetching item details:', error);
                                   return { ...detail, itemName: `Item ${detail.itemId}`, itemSprice: detail.price }; // Fallback
                              });
                      } else {
                          return Promise.resolve({
                                ...detail,
                              itemName: detail.menuItem.itemName,
                              itemSprice: detail.menuItem.itemSprice
                          });
                      }
                 });

                 Promise.all(fetchItemDetails).then(detailsWithNames => {
                     detailsWithNames.forEach(detail => {
                        const itemElement = document.createElement('div');
                        itemElement.className = 'flex justify-between items-start text-sm border-b border-gray-100 pb-2';
                        // Use the price from the order detail if available (online orders), otherwise use the selling price from item details (receipts)
                        const pricePerItem = order.type === 'online' && detail.price !== undefined ? detail.price : detail.itemSprice;
                        itemElement.innerHTML = `
                             <div class="flex-1 mr-4">
                                 <span>${detail.itemName} x ${detail.quantity}</span>
                             </div>
                             <div class="text-right">
                                <span>${formatCurrency(pricePerItem * detail.quantity)}</span>
                                ${detail.note ? `<div class="text-xs text-gray-500 mt-1">Ghi chú: ${detail.note}</div>` : ''} <!-- Assuming note can be in online order details -->
                             </div>
                         `;
                        itemsList.appendChild(itemElement);
                    });
                     });

                } else {
                itemsList.innerHTML = '<p class="text-center text-gray-500">Không có chi tiết món ăn.</p>';
            }

            // Handle status dropdown in modal
             const modalStatusDropdownContainer = document.getElementById('modalStatusDropdownContainer');
             const modalStatusSelect = document.getElementById('modalStatusSelect');
             const modalStatusBadge = document.getElementById('modalStatusBadge'); // Use the existing badge for receipts

             if (order.type === 'online') {
                 modalStatusDropdownContainer.classList.remove('hidden');
                 modalStatusBadge.classList.add('hidden'); // Hide badge for online orders when dropdown is visible

                 const currentStatus = order.status || 'PENDING';
                 const statuses = ['PENDING', 'CONFIRMED', 'PREPARING', 'DELIVERING', 'COMPLETED', 'CANCELLED'];
                 modalStatusSelect.innerHTML = statuses.map(status => `
                     <option value="${status}" ${currentStatus === status ? 'selected' : ''}>${status}</option>
                 `).join('');

                 // Remove previous event listener before adding a new one
                 modalStatusSelect.replaceWith(modalStatusSelect.cloneNode(true));
                 const newModalStatusSelect = document.getElementById('modalStatusSelect');

                 newModalStatusSelect.addEventListener('change', function(event) {
                     const newStatus = event.target.value;
                     console.log(`Attempting to update order ${order.id} status from modal to ${newStatus}`);
                     updateOrderStatus(order.id, newStatus); // Use order.id which is the backend ID
                 });

             } else { // Receipt
                 modalStatusDropdownContainer.classList.add('hidden');
                 modalStatusBadge.classList.remove('hidden'); // Show badge for receipts
             }


            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeOrderDetailsModal() {
            const modal = document.getElementById('orderDetailsModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // New function to update order status
        async function updateOrderStatus(orderId, newStatus) {
            try {
                // Use the PUT endpoint for updating status
                const response = await fetch(`http://localhost:8080/orders/${orderId}/status?newStatus=${newStatus}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                        // Add any necessary auth headers
                    },
                     // Body is not strictly needed for the backend's /status endpoint if using @RequestParam,
                     // but can be included if backend expects it or is changed to @RequestBody.
                     // Sending a simple JSON with status for potential compatibility:
                     body: JSON.stringify({ status: newStatus })
                });

                if (!response.ok) {
                     const errorText = await response.text();
                     throw new Error(`Failed to update order ${orderId} status to ${newStatus}: ${response.status} - ${errorText}`);
                }

                 // Optional: Update the order status in the allOrders array immediately for UI responsiveness
                 const updatedOrderIndex = allOrders.findIndex(order => order.type === 'online' && order.id == orderId);
                 if (updatedOrderIndex !== -1) {
                     allOrders[updatedOrderIndex].status = newStatus;
                     // Re-render the table to reflect the change immediately
                     applyFiltersAndSearch(); // This will also re-render the table
                 }

                console.log(`Order ${orderId} status updated to ${newStatus}`);
                // alert(`Cập nhật trạng thái đơn hàng #${orderId} thành công.`); // Optional: Show success message

            } catch (error) {
                console.error('Error updating order status:', error);
                 alert(`Không thể cập nhật trạng thái đơn hàng #${orderId}. Vui lòng thử lại.\nChi tiết lỗi: ${error.message}`);
                 // Optional: Revert the select dropdown visually on error if not already handled by re-fetch
                  fetchOrdersHistory(); // Re-fetch to ensure UI consistency
            }
        }
    </script>

    <!-- Order Details Modal -->
    <div id="orderDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg w-11/12 max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold">Chi tiết <span id="modalOrderId"></span></h3>
                <button onclick="closeOrderDetailsModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4 flex-1 overflow-y-auto">
                <div id="orderDetailsContent" class="space-y-4">
                    <!-- Order details will be loaded here -->
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-gray-600">Thời gian: <span class="font-medium text-gray-900" id="modalOrderTime"></span></p>
                            <p class="text-sm text-gray-600">Nhân viên: <span class="font-medium text-gray-900" id="modalEmployee">Nhân viên A</span></p>
                            <p class="text-sm text-gray-600">Khách hàng: <span class="font-medium text-gray-900" id="modalCustomer"></span></p>
                            <p class="text-sm text-gray-600">Địa chỉ: <span class="font-medium text-gray-900" id="modalAddress"></span></p>
                            <p class="text-sm text-gray-600">Phương thức: <span class="font-medium text-gray-900" id="modalPaymentMethod"></span></p>
                            <p class="text-sm text-gray-600" id="modalOrderNoteRow"><span class="font-medium text-gray-900" id="modalOrderNote"></span></p>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold text-orange-500 text-lg" id="modalTotalAmount"></p>
                            <!-- Status badge for receipts -->
                            <span class="px-2 py-1 text-xs font-medium rounded-full" id="modalStatusBadge"></span>
                            <!-- Status dropdown for online orders -->
                            <div id="modalStatusDropdownContainer" class="mt-2 hidden">
                                <select id="modalStatusSelect" class="status-select border border-gray-300 rounded-md text-xs px-2 py-1"></select>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-semibold mb-2">Chi tiết món ăn:</h4>
                        <div id="modalItemsList" class="border-t border-gray-200 pt-2 space-y-2">
                            <!-- Order items will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-200 flex justify-end items-center space-x-3">
                <button onclick="closeOrderDetailsModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-400">
                    Đóng
                 </button>
            </div>
        </div>
    </div>
</body>
</html>